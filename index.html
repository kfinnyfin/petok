<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PetOK App Demo</title>
    <style>
        /* ============================
           1. CORE VARIABLES & RESET
           ============================ */
        :root {
            --primary: #ff7b54;
            --primary-dark: #e06c4a;
            --secondary: #5030e5;
            --secondary-light: #7c5eff;
            --bg-body: #111827;
            --bg-app: #ffffff;
            --text-main: #1f2937;
            --text-muted: #6b7280;
            --border: #e5e7eb;
            --success: #10b981;
            --warning: #f59e0b;
            --error: #ef4444;
            --radius: 20px;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }

        body {
            background: var(--bg-body);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        /* ============================
           2. APP CONTAINER
           ============================ */
        .app-shell {
            width: 100%;
            max-width: 400px;
            height: 100%;
            max-height: 850px;
            background: var(--bg-app);
            position: relative;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }

        @media (min-width: 500px) {
            .app-shell {
                height: 90vh;
                border-radius: var(--radius);
                border: 8px solid #000;
            }
        }

        /* ============================
           3. HEADER
           ============================ */
        .header {
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #fff;
            border-bottom: 1px solid var(--border);
            z-index: 50;
            flex-shrink: 0;
        }
        .brand { font-size: 1.25rem; font-weight: 800; color: var(--primary); letter-spacing: -0.5px; display: flex; align-items: center; gap: 8px; }
        .brand-icon { font-size: 1.5rem; }
        .header-actions { display: flex; gap: 10px; }
        .btn-icon {
            width: 40px; height: 40px; border-radius: 50%; border: none;
            background: #f3f4f6; cursor: pointer; display: flex; align-items: center; justify-content: center;
            font-size: 1.2rem; transition: all 0.2s;
        }
        .btn-icon:hover { background: #e5e7eb; transform: scale(1.05); }
        .btn-icon.active { background: var(--primary); color: white; }

        /* ============================
           4. SCREENS SYSTEM
           ============================ */
        .screen {
            flex: 1; display: none; flex-direction: column; overflow-y: auto; position: relative; background: #fff;
        }
        .screen.active { display: flex; animation: fadeUp 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes fadeUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        /* ============================
           5. SCENE / STAGE COMPONENT (The Magic Fix)
           ============================ */
        /* This generic class makes any container a "Pet Stage" */
        .pet-stage {
            width: 100%;
            aspect-ratio: 1/1; /* Force Square Aspect Ratio */
            background: #000;
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        
        .pet-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; /* Let clicks pass through by default */
        }
        
        /* Image Layer */
        .stage-image {
            width: 100%; height: 100%; object-fit: contain;
            transform-origin: center; will-change: transform;
        }

        /* Mouth Guide Layer (Editor Only) */
        .mouth-overlay {
            position: absolute; 
            border: 2px solid rgba(255, 255, 255, 0.8);
            background: rgba(255, 123, 84, 0.15);
            border-radius: 12px;
            box-shadow: 0 0 0 9999px rgba(0,0,0,0.5); /* Dim effect */
            pointer-events: auto; /* Allow interaction */
            cursor: move;
        }
        .mouth-overlay::after {
            content: 'MOUTH'; position: absolute; top: -20px; left: 0; width: 100%;
            text-align: center; color: white; font-size: 10px; font-weight: bold;
            text-shadow: 0 1px 2px #000;
        }

        /* Prop Element */
        .stage-prop {
            position: absolute; font-size: 3rem; transform: translate(-50%, -50%);
            cursor: grab; pointer-events: auto;
            filter: drop-shadow(0 4px 6px rgba(0,0,0,0.3));
        }
        .stage-prop.selected { outline: 2px dashed #fff; background: rgba(255,255,255,0.1); border-radius: 8px; }

        /* Result Animation Layers */
        .anim-layer {
            position: absolute; left: 0; width: 100%; 
            overflow: hidden; pointer-events: none;
        }
        /* Top Half */
        .anim-head { top: 0; z-index: 2; border-bottom: 1px solid rgba(0,0,0,0.1); }
        /* Bottom Half */
        .anim-jaw { z-index: 1; transform-origin: top center; }
        
        /* The animation */
        @keyframes talk {
            0% { transform: translateY(0) rotate(0deg); }
            20% { transform: translateY(10%) rotate(-1deg); }
            50% { transform: translateY(2%) rotate(0deg); }
            70% { transform: translateY(12%) rotate(1deg); }
            100% { transform: translateY(0) rotate(0deg); }
        }
        .talking .anim-jaw { animation: talk 0.2s infinite alternate ease-in-out; }

        /* ============================
           6. UPLOAD SCREEN
           ============================ */
        .upload-container { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; text-align: center; }
        .upload-area {
            width: 100%; max-width: 300px; aspect-ratio: 1; border: 3px dashed var(--border); border-radius: 24px;
            display: flex; flex-direction: column; align-items: center; justify-content: center; background: #f9fafb;
            cursor: pointer; transition: all 0.3s; position: relative; margin-bottom: 30px;
        }
        .upload-area:hover { border-color: var(--primary); background: #fff5f2; transform: scale(1.02); }
        .upload-area input { position: absolute; width: 100%; height: 100%; opacity: 0; cursor: pointer; }
        .upload-icon { font-size: 4rem; margin-bottom: 15px; animation: float 3s ease-in-out infinite; }
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }

        /* ============================
           7. EDITOR SCREEN
           ============================ */
        .editor-workspace {
            flex: 1; background: #1a1a1a; display: flex; align-items: center; justify-content: center; padding: 20px;
        }
        .editor-controls { background: #fff; border-top: 1px solid var(--border); display: flex; flex-direction: column; z-index: 60; }
        
        /* Tabs */
        .tabs { display: flex; background: #f9fafb; padding: 5px; margin: 10px; border-radius: 12px; }
        .tab { flex: 1; padding: 10px; text-align: center; font-size: 0.85rem; font-weight: 600; color: var(--text-muted); cursor: pointer; border-radius: 8px; }
        .tab.active { background: white; color: var(--primary); box-shadow: 0 2px 5px rgba(0,0,0,0.05); }

        /* Tools */
        .tools-area { padding: 15px; height: 160px; overflow-y: auto; }
        .tool-group { display: none; height: 100%; flex-direction: column; gap: 15px; }
        .tool-group.active { display: flex; }
        
        .control-row { display: flex; align-items: center; gap: 10px; }
        .control-row label { width: 60px; font-size: 0.9rem; font-weight: 500; }
        input[type="range"] { flex: 1; accent-color: var(--primary); }
        
        .chip-container { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 5px; scrollbar-width: none; }
        .chip { padding: 6px 12px; background: #f3f4f6; border-radius: 20px; font-size: 0.85rem; cursor: pointer; white-space: nowrap; border: 1px solid transparent; }
        .chip.selected { background: var(--text-main); color: white; }

        .actions-bar { padding: 15px 20px; display: flex; gap: 12px; border-top: 1px solid #f3f4f6; }

        /* ============================
           8. COMPOSE & RESULT
           ============================ */
        .compose-container { padding: 20px; flex: 1; display: flex; flex-direction: column; background: #f9fafb; }
        
        /* Preview Boxes */
        .preview-wrapper { 
            width: 100%; max-width: 350px; margin: 0 auto 20px; 
            border-radius: 20px; overflow: hidden; box-shadow: 0 10px 20px rgba(0,0,0,0.1); 
        }

        textarea { width: 100%; height: 100px; padding: 15px; border: 2px solid var(--border); border-radius: 16px; font-size: 1rem; resize: none; }
        
        .voice-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin: 20px 0; }
        .voice-card { padding: 15px; border: 2px solid var(--border); border-radius: 12px; text-align: center; cursor: pointer; }
        .voice-card.active { border-color: var(--secondary); background: #f5f3ff; color: var(--secondary); font-weight: bold; }

        /* Utils */
        .btn-primary { padding: 16px; background: var(--primary); color: white; border: none; border-radius: 16px; font-size: 1rem; font-weight: 700; cursor: pointer; width: 100%; }
        .btn-secondary { padding: 14px; background: #f3f4f6; color: var(--text-main); border: none; border-radius: 12px; font-weight: 600; cursor: pointer; width: 100%; }
        
        /* Helpers */
        .toast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%) translateY(-100px); background: #333; color: white; padding: 10px 20px; border-radius: 50px; z-index: 1000; transition: transform 0.3s; }
        .toast.show { transform: translateX(-50%) translateY(0); }
        .loading-overlay { position: fixed; inset: 0; background: rgba(255,255,255,0.9); z-index: 999; display: none; flex-direction: column; align-items: center; justify-content: center; }
        .loading-overlay.active { display: flex; }
        .spinner { width: 40px; height: 40px; border: 4px solid #eee; border-top-color: var(--primary); border-radius: 50%; animation: spin 1s infinite linear; margin-bottom: 15px; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Profile & Gallery */
        .profile-head { text-align: center; padding: 20px; background: #fff; border-radius: 20px; margin-bottom: 20px; }
        .gallery-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; }
        .gallery-item { aspect-ratio: 1; background: #ddd; border-radius: 10px; overflow: hidden; }
        .gallery-item img { width: 100%; height: 100%; object-fit: cover; }

        /* Filters */
        .filter-sepia { filter: sepia(0.6); }
        .filter-bw { filter: grayscale(1); }
        .filter-cool { filter: hue-rotate(180deg); }
        .filter-warm { filter: sepia(0.3) saturate(1.5); }

    </style>
</head>
<body>

<div class="app-shell">
    
    <!-- HEADER -->
    <header class="header">
        <div class="brand"><span class="brand-icon">üê∂</span> PetOK</div>
        <div class="header-actions">
            <button class="btn-icon" onclick="nav('gallery')">üéûÔ∏è</button>
            <button class="btn-icon" onclick="nav('profile')">üë§</button>
        </div>
    </header>

    <div class="toast" id="toast">Message</div>
    <div class="loading-overlay" id="loader"><div class="spinner"></div><p>Processing...</p></div>

    <!-- 1. UPLOAD -->
    <div id="screen-upload" class="screen active">
        <div class="upload-container">
            <h1>Make Your Pet Talk</h1>
            <p style="color:var(--text-muted); margin-bottom:30px;">Upload a photo to get started</p>
            <div class="upload-area">
                <div class="upload-icon">üì∏</div>
                <h3>Tap to Upload</h3>
                <input type="file" id="fileInput" accept="image/*">
            </div>
            <button class="btn-secondary" onclick="loadSample()">Try Sample Image</button>
        </div>
    </div>

    <!-- 2. EDITOR -->
    <div id="screen-editor" class="screen">
        <div class="editor-workspace">
            <!-- THE MAIN STAGE -->
            <div id="editorStage" class="pet-stage">
                <!-- Content injected via JS renderPetScene() -->
            </div>
        </div>

        <div class="editor-panel">
            <div class="tabs">
                <div class="tab active" onclick="setTab('photo')">Photo</div>
                <div class="tab" onclick="setTab('mouth')">Mouth</div>
                <div class="tab" onclick="setTab('filters')">Filters</div>
                <div class="tab" onclick="setTab('props')">Props</div>
            </div>

            <div class="tools-area">
                <!-- PHOTO -->
                <div id="tool-photo" class="tool-group active">
                    <div class="control-row">
                        <label>Zoom</label>
                        <input type="range" id="zoomRange" min="0.5" max="3" step="0.1" value="1">
                    </div>
                    <div class="control-row">
                        <label>Rotate</label>
                        <input type="range" id="rotRange" min="-180" max="180" step="1" value="0">
                    </div>
                    <div style="display:flex; gap:10px; margin-top:10px;">
                        <button class="chip" onclick="resetTransform()">Reset</button>
                    </div>
                </div>
                <!-- MOUTH -->
                <div id="tool-mouth" class="tool-group">
                    <p style="font-size:0.8rem; text-align:center; color:var(--text-muted);">Drag box to mouth</p>
                    <div class="control-row">
                        <label>Width</label>
                        <input type="range" id="mouthW" min="50" max="250" value="120">
                    </div>
                    <div class="control-row">
                        <label>Height</label>
                        <input type="range" id="mouthH" min="20" max="150" value="60">
                    </div>
                </div>
                <!-- FILTERS -->
                <div id="tool-filters" class="tool-group">
                    <div class="chip-container">
                        <div class="chip selected" onclick="setFilter('')">Normal</div>
                        <div class="chip" onclick="setFilter('filter-sepia')">Vintage</div>
                        <div class="chip" onclick="setFilter('filter-bw')">B&W</div>
                        <div class="chip" onclick="setFilter('filter-cool')">Cool</div>
                        <div class="chip" onclick="setFilter('filter-warm')">Warm</div>
                    </div>
                </div>
                <!-- PROPS -->
                <div id="tool-props" class="tool-group">
                    <div class="chip-container">
                        <div class="chip" onclick="addProp('üï∂Ô∏è')">Glasses</div>
                        <div class="chip" onclick="addProp('üé©')">Hat</div>
                        <div class="chip" onclick="addProp('üéÄ')">Bow</div>
                        <div class="chip" onclick="addProp('üëë')">Crown</div>
                        <div class="chip" onclick="addProp('ü¶¥')">Bone</div>
                    </div>
                    <div class="control-row" style="margin-top:10px;">
                        <label>Size</label>
                        <input type="range" id="propSize" min="1" max="5" step="0.1" value="2">
                        <button class="chip" style="background:#fee2e2; color:red;" onclick="delProp()">Del</button>
                    </div>
                </div>
            </div>

            <div class="actions-bar">
                <button class="btn-secondary" onclick="nav('upload')">Back</button>
                <button class="btn-primary" onclick="nav('compose')">Next</button>
            </div>
        </div>
    </div>

    <!-- 3. COMPOSE -->
    <div id="screen-compose" class="screen">
        <div class="compose-container">
            <div class="preview-wrapper">
                <div id="composeStage" class="pet-stage"></div>
            </div>
            
            <textarea id="textInput" placeholder="Type what your pet says..."></textarea>
            
            <div class="voice-grid">
                <div class="voice-card active" onclick="setVoice('friendly', this)">Friendly</div>
                <div class="voice-card" onclick="setVoice('deep', this)">Deep</div>
                <div class="voice-card" onclick="setVoice('squeaky', this)">Squeaky</div>
                <div class="voice-card" onclick="setVoice('chirpy', this)">Chirpy</div>
            </div>

            <div style="margin-top:auto; display:flex; gap:10px;">
                <button class="btn-secondary" onclick="nav('editor')">Edit</button>
                <button class="btn-primary" onclick="generateVideo()">Generate</button>
            </div>
        </div>
    </div>

    <!-- 4. RESULT -->
    <div id="screen-result" class="screen">
        <div class="compose-container">
            <h2 style="text-align:center; margin-bottom:10px;">It's Alive!</h2>
            <div class="preview-wrapper">
                <div id="resultStage" class="pet-stage">
                    <!-- Head Layer -->
                    <div class="anim-layer anim-head"></div>
                    <!-- Jaw Layer -->
                    <div class="anim-layer anim-jaw"></div>
                </div>
            </div>
            
            <div style="display:flex; flex-direction:column; gap:10px;">
                <button class="btn-primary" id="btnPlay" onclick="playAudio()">‚ñ∂ Play</button>
                <div style="display:flex; gap:10px;">
                    <button class="btn-secondary" onclick="saveToGallery()">Save</button>
                    <button class="btn-secondary" onclick="nav('upload')">New</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 5. PROFILE & GALLERY (Simulated) -->
    <div id="screen-profile" class="screen">
        <div class="compose-container">
            <div class="profile-head">
                <div style="font-size:3rem;">üë§</div>
                <h2>PetLover_1</h2>
                <p>3 Videos Created</p>
            </div>
            <button class="btn-secondary" onclick="nav('upload')">Close</button>
        </div>
    </div>

    <div id="screen-gallery" class="screen">
        <div class="compose-container">
            <h2>Memories</h2>
            <div id="galleryGrid" class="gallery-grid" style="margin:20px 0;"></div>
            <button class="btn-secondary" onclick="nav('upload')">Back</button>
        </div>
    </div>

</div>

<script>
    // --- STATE ---
    const state = {
        src: null,
        imgX: 0, imgY: 0, scale: 1, rot: 0,
        mouth: { x: 0, y: 0, w: 120, h: 60 }, // Offsets from center
        props: [], // {id, char, x, y, size}
        filter: '',
        activeProp: null,
        voice: 'friendly'
    };

    // --- RENDER CORE (The Fix) ---
    // This renders the pet state into ANY container (editor, preview, result)
    // using percentages to ensure it scales perfectly.
    function renderPetScene(containerId, isInteractive = false) {
        const container = document.getElementById(containerId);
        container.innerHTML = ''; // Clear

        // 1. Image Layer
        const img = document.createElement('img');
        img.src = state.src;
        img.className = 'stage-image ' + state.filter;
        // Transform: Note we use percentages if possible, but px is fine if container matches
        // Since all containers are square (aspect-ratio: 1/1), we can use the same pixel offsets!
        // But to be safe if sizes differ, we should use a scale factor.
        // Let's assume the Editor is the "Source of Truth" (e.g. 1000 arbitrary units).
        // Actually, simpler: Apply the transforms directly. CSS handles the visual scaling of the box.
        // Wait, 'translate(50px)' is 50px on a small screen too. We need a scale factor.
        
        // Calculate Scale Factor based on visual width vs internal reference (let's say 350px reference)
        const currentWidth = container.offsetWidth || 350; 
        const baseWidth = 350; // Reference width from editor
        const ratio = currentWidth / baseWidth;

        img.style.transform = `translate(${state.imgX * ratio}px, ${state.imgY * ratio}px) scale(${state.scale}) rotate(${state.rot}deg)`;
        container.appendChild(img);

        // 2. Props Layer
        state.props.forEach(p => {
            const el = document.createElement('div');
            el.className = 'stage-prop';
            if(isInteractive && state.activeProp === p.id) el.classList.add('selected');
            el.innerText = p.char;
            
            // Position: Center + Offset * Ratio
            el.style.left = `calc(50% + ${p.x * ratio}px)`;
            el.style.top = `calc(50% + ${p.y * ratio}px)`;
            el.style.fontSize = `${p.size * ratio}rem`; // Scale text too
            
            if(isInteractive) {
                el.onmousedown = (e) => { e.stopPropagation(); selectProp(p.id); };
                el.ontouchstart = (e) => { e.stopPropagation(); selectProp(p.id); };
            }
            container.appendChild(el);
        });

        // 3. Interactive Layers (Editor Only)
        if(isInteractive) {
            // Mouth Guide
            const m = document.createElement('div');
            m.className = 'mouth-overlay';
            m.id = 'mouthDrag';
            m.style.width = (state.mouth.w * ratio) + 'px';
            m.style.height = (state.mouth.h * ratio) + 'px';
            m.style.left = `calc(50% + ${state.mouth.x * ratio}px)`;
            m.style.top = `calc(50% + ${state.mouth.y * ratio}px)`;
            m.style.transform = 'translate(-50%, -50%)'; // Center pivot
            container.appendChild(m);
        }
        
        return ratio; // Return ratio for external calculations if needed
    }

    // --- NAVIGATION ---
    function nav(screenId) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById('screen-' + screenId).classList.add('active');
        
        // Render triggers
        if(screenId === 'editor') setTimeout(() => renderPetScene('editorStage', true), 50);
        if(screenId === 'compose') setTimeout(() => renderPetScene('composeStage', false), 50);
        if(screenId === 'gallery') loadGallery();
    }

    function setTab(t) {
        document.querySelectorAll('.tool-group').forEach(g => g.classList.remove('active'));
        document.getElementById('tool-' + t).classList.add('active');
        document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));
        event.target.classList.add('active');
    }

    // --- UPLOAD ---
    const fileInput = document.getElementById('fileInput');
    fileInput.addEventListener('change', e => {
        if(e.target.files[0]) {
            const reader = new FileReader();
            reader.onload = evt => {
                state.src = evt.target.result;
                resetState();
                nav('editor');
            };
            reader.readAsDataURL(e.target.files[0]);
        }
    });

    function loadSample() {
        // Use a placeholder or draw a canvas
        const c = document.createElement('canvas'); c.width=400; c.height=400;
        const ctx = c.getContext('2d');
        ctx.fillStyle = "#8B5CF6"; ctx.fillRect(0,0,400,400);
        ctx.font="150px Arial"; ctx.textAlign="center"; ctx.fillText("üê∂",200,220);
        state.src = c.toDataURL();
        resetState();
        nav('editor');
    }

    function resetState() {
        state.imgX=0; state.imgY=0; state.scale=1; state.rot=0;
        state.mouth={x:0, y:0, w:120, h:60};
        state.props=[];
        state.filter='';
        // Reset Sliders
        document.getElementById('zoomRange').value = 1;
        document.getElementById('rotRange').value = 0;
    }

    // --- EDITOR LOGIC ---
    let dragItem = null; // 'image', 'mouth', propId
    let startPos = {x:0, y:0};
    
    const stage = document.getElementById('editorStage');
    
    stage.addEventListener('mousedown', startDrag);
    stage.addEventListener('touchstart', startDrag, {passive:false});
    window.addEventListener('mousemove', drag);
    window.addEventListener('touchmove', drag, {passive:false});
    window.addEventListener('mouseup', () => dragItem = null);
    window.addEventListener('touchend', () => dragItem = null);

    function startDrag(e) {
        if(!state.src) return;
        const t = e.target;
        const pt = e.touches ? e.touches[0] : e;
        startPos = { x: pt.clientX, y: pt.clientY };

        if(t.classList.contains('mouth-overlay')) dragItem = 'mouth';
        else if(t.id === 'editorStage' || t.classList.contains('stage-image')) dragItem = 'image';
        
        // Props selection handled in render loop via onclick
    }

    function drag(e) {
        if(!dragItem) return;
        if(e.cancelable) e.preventDefault();
        const pt = e.touches ? e.touches[0] : e;
        
        // Calculate Delta (Raw Pixels)
        const dx = pt.clientX - startPos.x;
        const dy = pt.clientY - startPos.y;
        startPos = { x: pt.clientX, y: pt.clientY };

        // We need to invert the "Ratio" used in render to store "Base Units"
        // render used: currentWidth / 350.
        const currentW = stage.offsetWidth;
        const ratio = currentW / 350; // This is the visual scale factor
        
        // Convert screen pixels to "State Units"
        const stateDx = dx / ratio;
        const stateDy = dy / ratio;

        if(dragItem === 'image') {
            state.imgX += stateDx;
            state.imgY += stateDy;
        } else if(dragItem === 'mouth') {
            state.mouth.x += stateDx;
            state.mouth.y += stateDy;
        } else if(typeof dragItem === 'number') {
            const p = state.props.find(i => i.id === dragItem);
            if(p) { p.x += stateDx; p.y += stateDy; }
        }

        renderPetScene('editorStage', true);
    }

    // --- TOOLBAR BINDINGS ---
    // Sliders
    document.getElementById('zoomRange').oninput = e => { state.scale = e.target.value; renderPetScene('editorStage', true); };
    document.getElementById('rotRange').oninput = e => { state.rot = e.target.value; renderPetScene('editorStage', true); };
    document.getElementById('mouthW').oninput = e => { state.mouth.w = e.target.value; renderPetScene('editorStage', true); };
    document.getElementById('mouthH').oninput = e => { state.mouth.h = e.target.value; renderPetScene('editorStage', true); };
    
    // Props
    function addProp(char) {
        const id = Date.now();
        state.props.push({ id, char, x:0, y:0, size:2 });
        selectProp(id);
    }
    function selectProp(id) {
        state.activeProp = id;
        dragItem = id; // Start dragging immediately
        const p = state.props.find(i => i.id === id);
        if(p) document.getElementById('propSize').value = p.size;
        renderPetScene('editorStage', true);
        setTab('props');
    }
    document.getElementById('propSize').oninput = e => {
        const p = state.props.find(i => i.id === state.activeProp);
        if(p) { p.size = e.target.value; renderPetScene('editorStage', true); }
    };
    function delProp() {
        state.props = state.props.filter(i => i.id !== state.activeProp);
        renderPetScene('editorStage', true);
    }
    
    function setFilter(f) { state.filter = f; renderPetScene('editorStage', true); }
    function resetTransform() { 
        state.imgX=0; state.imgY=0; state.scale=1; state.rot=0; 
        document.getElementById('zoomRange').value=1;
        document.getElementById('rotRange').value=0;
        renderPetScene('editorStage', true); 
    }

    // --- COMPOSE ---
    function setVoice(v, el) {
        state.voice = v;
        document.querySelectorAll('.voice-card').forEach(c => c.classList.remove('active'));
        el.classList.add('active');
    }

    // --- GENERATE (RESULT) ---
    function generateVideo() {
        const txt = document.getElementById('textInput').value;
        if(!txt) { showToast("Please type something!", "error"); return; }
        
        document.getElementById('loader').classList.add('active');
        
        setTimeout(() => {
            document.getElementById('loader').classList.remove('active');
            nav('result');
            setupAnimation();
        }, 1500);
    }

    function setupAnimation() {
        // Here we duplicate the render logic but into TWO layers (Head/Jaw)
        // using clip-paths to split them based on state.mouth position.
        
        const container = document.getElementById('resultStage');
        // We use the same render logic to populate the layers
        // BUT we need to clone the DOM or re-run render logic for each layer?
        // Simpler: Render a "Master" stage then clone it into Head/Jaw divs? 
        // No, `renderPetScene` targets an ID.
        
        // 1. Render Full Scene into Head Layer
        const headLayer = container.querySelector('.anim-head');
        // We need a wrapper inside to render into
        let headContent = document.createElement('div'); 
        headContent.id = 'animHeadTarget'; 
        headContent.style.width='100%'; headContent.style.height='100%';
        headLayer.innerHTML = ''; headLayer.appendChild(headContent);
        
        // Render
        const ratio = renderPetScene('animHeadTarget', false);
        
        // 2. Clone it for Jaw
        const jawLayer = container.querySelector('.anim-jaw');
        jawLayer.innerHTML = headLayer.innerHTML; // Exact copy
        
        // 3. Calculate Split Percentage
        // Mouth Y is offset from center (0). 
        // In the stage, center is 50%.
        // Offset in pixels = state.mouth.y * ratio.
        // Stage Height in pixels = container.offsetHeight.
        const h = container.offsetHeight;
        const splitPx = (h/2) + (state.mouth.y * ratio);
        const splitPct = (splitPx / h) * 100;
        
        // 4. Apply Masks
        // Head: Visible from 0% to splitPct%
        headLayer.style.clipPath = `inset(0 0 ${100 - splitPct}% 0)`;
        
        // Jaw: Visible from splitPct% to 100%
        jawLayer.style.clipPath = `inset(${splitPct}% 0 0 0)`;
        
        // 5. Pivot
        jawLayer.style.transformOrigin = `50% ${splitPct}%`;
    }

    function playAudio() {
        const btn = document.getElementById('btnPlay');
        const jaw = document.querySelector('.anim-jaw');
        
        jaw.parentElement.classList.add('talking');
        btn.innerText = "Playing...";
        
        const u = new SpeechSynthesisUtterance(document.getElementById('textInput').value);
        
        // Tuned Voice Settings
        if(state.voice === 'friendly') { u.pitch = 1.1; u.rate = 1.0; }
        if(state.voice === 'deep') { u.pitch = 0.4; u.rate = 0.8; }
        if(state.voice === 'squeaky') { u.pitch = 2.0; u.rate = 1.1; }
        if(state.voice === 'chirpy') { u.pitch = 1.6; u.rate = 1.4; }
        
        u.onend = () => {
            jaw.parentElement.classList.remove('talking');
            btn.innerText = "‚ñ∂ Play";
        };
        window.speechSynthesis.speak(u);
    }

    // --- HELPERS ---
    function showToast(msg, type='success') {
        const t = document.getElementById('toast');
        t.innerText = msg;
        t.className = 'toast show ' + type;
        setTimeout(() => t.className = 'toast', 3000);
    }

    function saveToGallery() {
        const gal = document.getElementById('galleryGrid');
        const div = document.createElement('div');
        div.className = 'gallery-item';
        div.innerHTML = `<img src="${state.src}" style="width:100%; height:100%; object-fit:cover;">`;
        if(gal.children.length === 0) gal.innerHTML = '';
        gal.prepend(div);
        showToast("Saved to Memories!");
    }
    
    function loadGallery() {
        const gal = document.getElementById('galleryGrid');
        if(gal.children.length === 0) gal.innerHTML = '<p style="color:#999; grid-column:span 3; text-align:center; padding:20px;">No videos yet.</p>';
    }

    // Init
    loadGallery();

</script>
<!-- Screenshot Tool -->
<script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
</body>
</html>
